---
// src/pages/auth/callback.astro
// Maneja el callback de autenticación de Google OAuth

import { supabase } from '../../lib/supabase';

export const prerender = false;

console.log('=== CALLBACK START ===');
console.log('URL:', Astro.url.toString());
console.log('Search params:', Astro.url.searchParams.toString());

// Obtener el código de autorización (response_type=code)
const code = Astro.url.searchParams.get('code');
const error = Astro.url.searchParams.get('error');
const errorDescription = Astro.url.searchParams.get('error_description');

console.log('Code:', code);
console.log('Error:', error);
console.log('Error description:', errorDescription);

if (error) {
  console.error('OAuth Error:', error, errorDescription);
  return Astro.redirect(`/?error=${encodeURIComponent(error)}`);
}

if (!code) {
  console.error('No authorization code received');
  return Astro.redirect('/?error=no_code');
}

try {
  // Intercambiar el código por una sesión
  console.log('Exchanging code for session...');
  const { data, error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);
  
  if (exchangeError || !data.session) {
    console.error('Session exchange error:', exchangeError);
    throw exchangeError || new Error('Could not exchange code for session');
  }

  console.log('Session obtained:', data.session.user.email);

  const user = data.session.user;

  // Verificar/crear usuario en tabla usuarios
  const { data: existingUser, error: fetchError } = await supabase
    .from('usuarios')
    .select('id')
    .eq('email', user.email)
    .single();

  if (fetchError && fetchError.code !== 'PGRST116') {
    console.error('Error checking user:', fetchError);
    throw fetchError;
  }

  if (!existingUser) {
    // Crear nuevo usuario
    console.log('Creating new user in database...');
    
    const { error: insertError } = await supabase
      .from('usuarios')
      .insert([
        {
          email: user.email,
          nombre: user.user_metadata?.full_name || user.email.split('@')[0],
          proveedor_autenticacion: 'google',
          google_id: user.id,
          foto_perfil: user.user_metadata?.avatar_url,
          ultimo_acceso: new Date().toISOString(),
          activo: true
        }
      ]);

    if (insertError) {
      console.error('Error creating user:', insertError);
      throw insertError;
    }

    console.log('User created successfully');
  } else {
    // Actualizar último acceso
    console.log('User already exists, updating last login...');
    
    const { error: updateError } = await supabase
      .from('usuarios')
      .update({
        ultimo_acceso: new Date().toISOString(),
        proveedor_autenticacion: 'google'
      })
      .eq('email', user.email);

    if (updateError) {
      console.error('Error updating user:', updateError);
    }
  }

  // Guardar sesión en cookies
  console.log('Setting session cookies...');
  
  const authToken = data.session.access_token;
  const refreshToken = data.session.refresh_token;

  Astro.cookies.set('sb-access-token', authToken, {
    path: '/',
    maxAge: 60 * 60 * 24 * 7, // 7 días
    httpOnly: true,
    secure: true,
    sameSite: 'lax'
  });

  if (refreshToken) {
    Astro.cookies.set('sb-refresh-token', refreshToken, {
      path: '/',
      maxAge: 60 * 60 * 24 * 30, // 30 días
      httpOnly: true,
      secure: true,
      sameSite: 'lax'
    });
  }

  Astro.cookies.set('user-email', user.email, {
    path: '/',
    maxAge: 60 * 60 * 24 * 7, // 7 días
  });

  console.log('=== CALLBACK SUCCESS ===');
  return Astro.redirect('/');

} catch (err) {
  console.error('Callback error:', err);
  const message = err instanceof Error ? err.message : 'Unknown error';
  return Astro.redirect(`/?error=${encodeURIComponent(message)}`);
}
---

<BaseLayout title="Autenticación completada" description="Redirigiendo...">
  {error && (
    <div class="flex items-center justify-center min-h-screen bg-gray-50">
      <div class="text-center">
        <h1 class="text-2xl font-bold text-red-600 mb-2">Error de autenticación</h1>
        <p class="text-gray-600 mb-6">{error}</p>
        <a href="/auth/login" class="text-red-600 hover:text-red-700 font-semibold">
          Volver al login
        </a>
      </div>
    </div>
  )}
  
  {!error && userId && (
    <div class="flex items-center justify-center min-h-screen bg-gray-50">
      <div class="text-center">
        <div class="mb-4 spinner">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">¡Sesión iniciada!</h1>
        <p class="text-gray-600">Redirigiendo a tu cuenta...</p>
      </div>
    </div>
  )}

  <script>
    // Script para manejar la redirección en el cliente
    document.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      const next = params.get('next') || '/';
      
      // Redirigir después de un momento
      setTimeout(function() {
        window.location.href = next;
      }, 1500);
    });
  </script>

  <style>
    .spinner {
      animation: spin 1s ease-in-out;
    }

    @keyframes spin {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }
  </style>
</BaseLayout>



