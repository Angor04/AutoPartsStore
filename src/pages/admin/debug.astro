---
// src/pages/admin/debug.astro
export const prerender = false;

import AdminLayout from "@/layouts/AdminLayout.astro";
import { getSupabaseAdmin } from "@/lib/supabase";
import type { AdminUser } from "@/types";

// Datos del usuario del middleware
const user = Astro.locals.user;
const admin = Astro.locals.admin;

// Intentar obtener datos de admin_users
let adminUserData: AdminUser | null = null;
let adminUserError: string | null = null;
let allAdminUsers: AdminUser[] = [];

if (user?.id) {
  const supabaseAdmin = getSupabaseAdmin();
  
  // Buscar este usuario en admin_users
  const { data, error } = await supabaseAdmin
    .from('admin_users')
    .select('*')
    .eq('id', user.id)
    .single();
  
  adminUserData = data;
  adminUserError = error?.message || null;

  // Obtener TODOS los admins (para debugging)
  const { data: allData } = await supabaseAdmin
    .from('admin_users')
    .select('*');
  allAdminUsers = (allData as AdminUser[]) || [];
}
---

<AdminLayout>
  <div style="padding: 20px; background: #f5f5f5; border-radius: 8px;">
    <h2 style="color: #333; margin-bottom: 20px;">üîç DEBUG - Informaci√≥n de Autenticaci√≥n</h2>

    <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #667eea;">
      <h3 style="color: #667eea; margin: 0 0 10px 0;">Usuario Autenticado (del middleware)</h3>
      <pre style="margin: 0; font-size: 12px; color: #333; background: #f9f9f9; padding: 10px; border-radius: 4px;">{JSON.stringify({
        email: user?.email,
        id: user?.id,
        nombre: admin?.nombre
      }, null, 2)}</pre>
    </div>

    <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #764ba2;">
      <h3 style="color: #764ba2; margin: 0 0 10px 0;">B√∫squeda en admin_users (por ID)</h3>
      {adminUserError ? (
        <div style="color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px;">
          ‚ùå Error: {adminUserError}
        </div>
      ) : adminUserData ? (
        <pre style="margin: 0; font-size: 12px; color: #333; background: #f9f9f9; padding: 10px; border-radius: 4px;">{JSON.stringify(adminUserData, null, 2)}</pre>
      ) : (
        <div style="color: #f57c00; background: #fff3e0; padding: 10px; border-radius: 4px;">
          ‚ö†Ô∏è No encontrado en tabla admin_users
        </div>
      )}
    </div>

    <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #388e3c;">
      <h3 style="color: #388e3c; margin: 0 0 10px 0;">Todos los admin_users en la BD ({allAdminUsers.length})</h3>
      {allAdminUsers.length > 0 ? (
        <pre style="margin: 0; font-size: 12px; color: #333; background: #f9f9f9; padding: 10px; border-radius: 4px; overflow-x: auto;">{JSON.stringify(allAdminUsers, null, 2)}</pre>
      ) : (
        <div style="color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px;">
          ‚ùå No hay registros en admin_users
        </div>
      )}
    </div>

    <div style="background: #fff3e0; padding: 15px; border-radius: 6px; border-left: 4px solid #f57c00;">
      <h3 style="color: #f57c00; margin: 0 0 10px 0;">Qu√© hacer ahora:</h3>
      <ol style="margin: 0; padding-left: 20px; color: #333;">
        <li><strong>Si "Usuario Autenticado" est√° vac√≠o:</strong> El token no es v√°lido. Intenta login de nuevo.</li>
        <li><strong>Si "B√∫squeda en admin_users" muestra error:</strong> La tabla no existe o no tiene datos.</li>
        <li><strong>Si "Todos los admin_users" est√° vac√≠o:</strong> Copia el ID del usuario autenticado y ejecuta el INSERT de SQL.</li>
        <li><strong>Si todo est√° completo:</strong> ¬°El admin debe estar activado correctamente!</li>
      </ol>
    </div>

    <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #388e3c;">
      <p style="margin: 0; color: #333;">
        <strong>ID para copiar en SQL:</strong> <code style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px; font-family: monospace;">{user?.id}</code>
      </p>
    </div>
  </div>
</AdminLayout>
