---
// src/pages/admin/categorias/index.astro
// Gestión de categorías

export const prerender = false;

import AdminLayout from "@/layouts/AdminLayout.astro";
import { getCategories } from "@/lib/supabase";
import type { Category } from "@/types";

const categories = await getCategories();
---

<AdminLayout>
  <style>
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 8px; padding: 30px; width: 90%; max-width: 400px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #764ba2; }
    .btn-secondary { background: #e5e7eb; color: #1a1a1a; }
    .btn-danger { background: #ef4444; color: white; padding: 6px 12px; font-size: 13px; }
    .btn-danger:hover { background: #dc2626; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
    .card { background: white; border-radius: 8px; padding: 20px; border: 1px solid #e5e7eb; }
    .card-title { font-size: 18px; font-weight: bold; color: #1a1a1a; margin-bottom: 10px; }
    .card-text { color: #666; font-size: 14px; margin-bottom: 15px; }
    .card-actions { display: flex; gap: 8px; }

    /* Confirm modal */
    .confirm-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1100; align-items: center; justify-content: center; }
    .confirm-overlay.show { display: flex; }
    .confirm-box { background: white; border-radius: 12px; padding: 28px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .confirm-icon { width: 48px; height: 48px; margin: 0 auto 16px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .confirm-icon svg { width: 24px; height: 24px; color: #ef4444; }
    .confirm-title { font-size: 18px; font-weight: 700; color: #1a1a1a; margin-bottom: 8px; }
    .confirm-text { font-size: 14px; color: #6b7280; margin-bottom: 24px; line-height: 1.5; }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }
    .confirm-actions .btn { min-width: 110px; }
  </style>

  <div style="margin-bottom: 32px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <div>
        <h2 style="font-size: 24px; font-weight: bold; color: #1a1a1a; margin: 0;">Categorías</h2>
        <p style="color: #666; margin: 5px 0 0 0;">Total: {categories.length} categorías</p>
      </div>
      <button class="btn btn-primary" onclick="openModal()">+ Nueva Categoría</button>
    </div>

    <!-- Modal -->
    <div id="categoryModal" class="modal">
      <div class="modal-content">
        <div style="font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #1a1a1a;">Nueva Categoría</div>
        <form id="categoryForm" onsubmit="handleSubmit(event)">
          <div class="form-group">
            <label>Nombre *</label>
            <input type="text" id="nombre" name="nombre" required>
          </div>

          <div class="form-group">
            <label>Slug (URL) *</label>
            <input type="text" id="slug" name="slug" placeholder="ej: ropa-hombre" required>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn btn-primary">Crear</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmModal" class="confirm-overlay">
      <div class="confirm-box">
        <div class="confirm-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        <div class="confirm-title">¿Eliminar categoría?</div>
        <div class="confirm-text">Esta acción no se puede deshacer. Todos los productos asociados quedarán sin categoría.</div>
        <div class="confirm-actions">
          <button class="btn btn-secondary" onclick="closeConfirm()">Cancelar</button>
          <button class="btn btn-danger" id="confirmDeleteBtn" style="padding: 10px 20px;">Eliminar</button>
        </div>
      </div>
    </div>

    <!-- Grid de categorías -->
    {categories.length === 0 ? (
      <div style="background: white; padding: 60px 24px; border-radius: 8px; text-align: center;">
        <p style="color: #999; margin: 0;">No hay categorías. <button onclick="openModal()" style="color: #667eea; text-decoration: underline; background: none; border: none; cursor: pointer;">Crear la primera</button></p>
      </div>
    ) : (
      <div class="grid">
        {categories.map(cat => (
          <div class="card">
            <div class="card-title">{cat.nombre}</div>
            <div class="card-text">
              <small style="color: #999;">Slug: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">{cat.slug}</code></small>
            </div>
            <div class="card-actions">
              <button class="btn btn-danger" onclick={`deleteCategory('${cat.id}')`}>Eliminar</button>
            </div>
          </div>
        ))}
      </div>
    )}
  </div>

  <script>
    (window as any).openModal = function(): void {
      const modal = document.getElementById('categoryModal');
      const form = document.getElementById('categoryForm');
      if (modal) modal.classList.add('show');
      if (form && form instanceof HTMLFormElement) form.reset();
    };

    (window as any).closeModal = function(): void {
      const modal = document.getElementById('categoryModal');
      if (modal) modal.classList.remove('show');
    };

    (window as any).handleSubmit = async function(e: Event): Promise<void> {
      e.preventDefault();
      const formElement = document.getElementById('categoryForm');
      if (!formElement || !(formElement instanceof HTMLFormElement)) return;
      
      const formData = new FormData(formElement);

      try {
        const response = await fetch('/api/admin/categorias/crear', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          location.reload();
        } else {
          const error = await response.json() as Record<string, string>;
          alert('Error: ' + (error.error || 'Error desconocido'));
        }
      } catch (error) {
        const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
        alert('Error: ' + errorMessage);
      }
    };

    let pendingDeleteId: string | null = null;

    function openConfirm(id: string): void {
      pendingDeleteId = id;
      const modal = document.getElementById('confirmModal');
      if (modal) modal.classList.add('show');
    }

    (window as any).closeConfirm = function(): void {
      pendingDeleteId = null;
      const modal = document.getElementById('confirmModal');
      if (modal) modal.classList.remove('show');
    };

    // Wire up the confirm button
    document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
      if (!pendingDeleteId) return;
      const id = pendingDeleteId;
      (window as any).closeConfirm();

      try {
        const response = await fetch(`/api/admin/categorias/eliminar?id=${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          location.reload();
        } else {
          const error = await response.json() as Record<string, string>;
          alert('Error: ' + (error.error || 'Error desconocido'));
        }
      } catch (error) {
        const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
        alert('Error: ' + errorMessage);
      }
    });

    (window as any).deleteCategory = function(id: string): void {
      openConfirm(id);
    };

    const categoryModal = document.getElementById('categoryModal');
    if (categoryModal) {
      categoryModal.addEventListener('click', function(e: Event) {
        if (e.target === this) (window as any).closeModal();
      });
    }
  </script>
</AdminLayout>
