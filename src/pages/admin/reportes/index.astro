---
// src/pages/admin/reportes/index.astro
// Reportes y análisis

export const prerender = false;

import AdminLayout from "@/layouts/AdminLayout.astro";
import { getSupabaseAdmin } from "@/lib/supabase";
import { formatPrice } from "@/lib/utils";
import type { Order, Product } from "@/types";

const supabaseAdmin = getSupabaseAdmin();

// Obtener datos para reportes
const { data: ordenesData } = await supabaseAdmin
  .from('ordenes')
  .select('*')
  .order('creado_en', { ascending: false });

const { data: productosData } = await supabaseAdmin
  .from('productos')
  .select('*');

const ordenes = (ordenesData as Order[] | null) || [];
const productos = (productosData as Product[] | null) || [];

// Calcular estadísticas
const totalVentas = ordenes?.reduce((sum, o: Order) => sum + (o.total || 0), 0) || 0;
const totalOrdenes = ordenes?.length || 0;
const ventasCompletadas = ordenes?.filter((o: Order) => o.estado === 'completada').reduce((sum, o: Order) => sum + (o.total || 0), 0) || 0;
const productoTotal = productos?.length || 0;

// Productos más vendidos
// Productos con más stock
const productosMasStock = productos
  ?.sort((a, b) => (b.stock || 0) - (a.stock || 0))
  .slice(0, 5)
  .map((p: Product) => ({
    nombre: p.nombre,
    precio: p.precio,
    stock: p.stock || 0
  })) || [];
---

<AdminLayout title="Reportes" description="Análisis y gráficas del negocio">
  <div style="margin-bottom: 32px;">
    <h2 style="font-size: 24px; font-weight: bold; color: #1a1a1a; margin-bottom: 24px;">Reportes y Análisis</h2>

    <!-- Tarjetas de estadísticas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 32px;">
      <div style="background: white; padding: 24px; border-radius: 8px; border-left: 4px solid #667eea;">
        <div style="color: #666; font-size: 14px;">Ventas Totales</div>
        <div style="font-size: 36px; font-weight: bold; color: #1a1a1a;">{formatPrice(totalVentas)}</div>
      </div>
      <div style="background: white; padding: 24px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
        <div style="color: #666; font-size: 14px;">Órdenes Totales</div>
        <div style="font-size: 36px; font-weight: bold; color: #1a1a1a;">{totalOrdenes}</div>
      </div>
      <div style="background: white; padding: 24px; border-radius: 8px; border-left: 4px solid #10b981;">
        <div style="color: #666; font-size: 14px;">Ventas Completadas</div>
        <div style="font-size: 36px; font-weight: bold; color: #1a1a1a;">{formatPrice(ventasCompletadas)}</div>
      </div>
      <div style="background: white; padding: 24px; border-radius: 8px; border-left: 4px solid #f59e0b;">
        <div style="color: #666; font-size: 14px;">Productos</div>
        <div style="font-size: 36px; font-weight: bold; color: #1a1a1a;">{productoTotal}</div>
      </div>
    </div>

    <!-- Tabla de productos -->
    <div style="background: white; padding: 24px; border-radius: 8px; margin-bottom: 24px;">
      <div style="font-size: 18px; font-weight: bold; color: #1a1a1a; margin-bottom: 16px;">Productos con más inventario</div>
      <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: #f9fafb;">
          <tr>
            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Nombre</th>
            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Precio</th>
            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Stock</th>
          </tr>
        </thead>
        <tbody>
          {productosMasStock.length === 0 ? (
            <tr>
              <td colspan="3" style="text-align: center; padding: 40px; color: #999;">No hay productos</td>
            </tr>
          ) : (
            productosMasStock.map(p => (
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px; font-weight: 600;">{p.nombre}</td>
                <td style="padding: 12px;">{formatPrice(p.precio)}</td>
                <td style="padding: 12px;">
                  <span style={`display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; ${
                    p.stock === 0 ? 'background: #fee2e2; color: #991b1b;' :
                    p.stock < 5 ? 'background: #fef3c7; color: #92400e;' :
                    'background: #dcfce7; color: #166534;'
                  }`}>
                    {p.stock} unidades
                  </span>
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  </div>
