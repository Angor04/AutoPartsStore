---
// src/pages/admin/index.astro
// Dashboard principal del admin

export const prerender = false;

import AdminLayout from "@/layouts/AdminLayout.astro";
import { getProducts } from "@/lib/supabase";
import { formatNumber } from "@/lib/utils";

// Obtener productos para calcular estadísticas
const productos = await getProducts();

// Calcular estadísticas
const totalProductos = productos.length;
const stockTotal = productos.reduce((sum, p) => sum + (p.stock || 0), 0);
const productosAgotados = productos.filter(p => p.stock === 0 || p.stock === null).length;

// Valor inventario basado en precio original (valor real del stock)
const valorInventario = productos.reduce((sum, p) => {
  const precioBase = p.precio_original || p.precio; // Usar precio_original si existe
  return sum + (precioBase * (p.stock || 0));
}, 0);

// Descuento total en el inventario
const descuentoTotal = productos.reduce((sum, p) => {
  if (p.precio_original && p.precio_original > p.precio) {
    const descuento = (p.precio_original - p.precio) * (p.stock || 0);
    return sum + descuento;
  }
  return sum;
}, 0);
---

<AdminLayout title="Dashboard" description="Resumen general del negocio">
  <!-- Header -->
  <div style="margin-bottom: 32px;">
    <h2 style="font-size: 24px; font-weight: bold; color: #1a1a1a;">Bienvenido al Panel de Control</h2>
    <p style="color: #666; margin-top: 8px;">Aquí tienes un resumen de tu negocio</p>
  </div>

  <!-- Widgets Grid -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <!-- Widget: Total Productos -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <p style="color: #888; font-size: 14px;">Total de Productos</p>
          <h3 style="font-size: 32px; font-weight: bold; color: #1a1a1a; margin-top: 8px;">{totalProductos}</h3>
        </div>
      </div>
      <p style="color: #0ea5e9; font-size: 12px; margin-top: 12px;">Productos activos en catálogo</p>
    </div>

    <!-- Widget: Stock Total -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <p style="color: #888; font-size: 14px;">Stock Total</p>
          <h3 style="font-size: 32px; font-weight: bold; color: #1a1a1a; margin-top: 8px;">{stockTotal}</h3>
        </div>
      </div>
      <p style="color: #0ea5e9; font-size: 12px; margin-top: 12px;">Unidades en inventario</p>
    </div>

    <!-- Widget: Productos Agotados -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <p style="color: #888; font-size: 14px;">Productos Agotados</p>
          <h3 style="font-size: 32px; font-weight: bold; color: #dc2626; margin-top: 8px;">{productosAgotados}</h3>
        </div>
      </div>
      <p style="color: #dc2626; font-size: 12px; margin-top: 12px;">Requieren reabastecimiento</p>
    </div>

    <!-- Widget: Valor Inventario -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <p style="color: #888; font-size: 14px;">Valor Inventario (sin descuentos)</p>
          <h3 style="font-size: 32px; font-weight: bold; color: #1a1a1a; margin-top: 8px;">${formatNumber(valorInventario)}</h3>
        </div>
      </div>
      <p style="color: #0ea5e9; font-size: 12px; margin-top: 12px;">Valor total del stock</p>
    </div>

    <!-- Widget: Descuento Total -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <p style="color: #888; font-size: 14px;">Descuento en Inventario</p>
          <h3 style="font-size: 32px; font-weight: bold; color: #dc2626; margin-top: 8px;">${formatNumber(descuentoTotal)}</h3>
        </div>
      </div>
      <p style="color: #dc2626; font-size: 12px; margin-top: 12px;">Dinero en ofertas del stock</p>
    </div>
  </div>
</AdminLayout>