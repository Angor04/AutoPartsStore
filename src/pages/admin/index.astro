---
// src/pages/admin/index.astro
// Dashboard principal del admin

export const prerender = false;

import AdminLayout from "@/layouts/AdminLayout.astro";
import { getProducts } from "@/lib/supabase";
import { formatNumber } from "@/lib/utils";
import { getLowStockAlerts } from "@/lib/stockManagement";
import DashboardCharts from "@/components/admin/DashboardCharts";

// Obtener productos para calcular estadísticas
const productos = await getProducts();

// Obtener alertas de bajo stock (productos con menos de 10 unidades)
const { alerts: productosBalsoStock, error: alertError } = 
  await getLowStockAlerts(10);

console.log('Alertas de bajo stock:', productosBalsoStock?.length || 0);
if (alertError) {
  console.error('Error obteniendo alertas:', alertError);
}

// Calcular estadísticas
const totalProductos = productos.length;
const stockTotal = productos.reduce((sum, p) => sum + (p.stock || 0), 0);
const productosAgotados = productos.filter(p => p.stock === 0 || p.stock === null).length;

// Valor inventario basado en precio original (valor real del stock)
const valorInventario = productos.reduce((sum, p) => {
  const precioBase = p.precio_original || p.precio; // Usar precio_original si existe
  return sum + (precioBase * (p.stock || 0));
}, 0);

// DATOS NUEVOS: Ingresos de hoy y Últimas órdenes
import { getSupabaseAdmin } from "@/lib/supabase";
const supabaseAdmin = getSupabaseAdmin();

// 1. Ingresos de Hoy
const startOfToday = new Date();
startOfToday.setHours(0,0,0,0);
const endOfToday = new Date();
endOfToday.setHours(23,59,59,999);

const { data: ordenesHoy } = await supabaseAdmin
  .from('ordenes')
  .select('total')
  .gte('creado_en', startOfToday.toISOString())
  .lte('creado_en', endOfToday.toISOString())
  .neq('estado', 'cancelada');

const ingresosHoy = ordenesHoy?.reduce((sum, orden) => sum + (orden.total || 0), 0) || 0;

// 2. Últimas 5 Órdenes
const { data: ultimasOrdenesData } = await supabaseAdmin
  .from('ordenes')
  .select('*')
  .order('creado_en', { ascending: false })
  .limit(5);

const ultimasOrdenes = ultimasOrdenesData || [];
---

<AdminLayout title="Dashboard" description="Resumen general del negocio">
  <!-- Header con Valor Inventario Destacado -->
  <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h2 style="font-size: 24px; font-weight: bold; color: #1a1a1a; margin: 0;">Panel de Control</h2>
      <p style="color: #666; margin: 4px 0 0 0;">Resumen general de tu negocio</p>
    </div>
    <div style="text-align: right;">
      <p style="color: #666; font-size: 14px; margin: 0;">Valor Total del Inventario</p>
      <h3 style="font-size: 36px; font-weight: bold; color: #4f46e5; margin: 4px 0 0 0;">{formatNumber(valorInventario)} €</h3>
    </div>
  </div>

  <!-- Alertas de Bajo Stock (si hay) -->
  {productosBalsoStock && productosBalsoStock.length > 0 && (
    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
      <div style="display: flex; gap: 12px;">
        <svg style="flex-shrink: 0; width: 24px; height: 24px; color: #d97706;" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 0 11-2 0 1 1 0 012 0zm-1-8a1 0 00-1 1v3a1 0 002 0V6a1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
        <div style="flex: 1;">
          <h3 style="font-weight: bold; color: #92400e; margin: 0;">Alerta de Stock Bajo</h3>
          <p style="color: #b45309; margin: 4px 0 0 0; font-size: 14px;">
            {productosBalsoStock.length} {productosBalsoStock.length === 1 ? 'producto' : 'productos'} con stock menor a 10 unidades
          </p>
        </div>
      </div>
    </div>
  )}

  <!-- Widgets Grid -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <!-- Widget: Total Productos -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <p style="color: #888; font-size: 14px;">Total de Productos</p>
          <h3 style="font-size: 32px; font-weight: bold; color: #1a1a1a; margin-top: 8px;">{totalProductos}</h3>
        </div>
      </div>
      <p style="color: #0ea5e9; font-size: 12px; margin-top: 12px;">Productos activos en catálogo</p>
    </div>

    <!-- Widget: Stock Total -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <p style="color: #888; font-size: 14px;">Stock Total</p>
          <h3 style="font-size: 32px; font-weight: bold; color: #1a1a1a; margin-top: 8px;">{stockTotal}</h3>
        </div>
      </div>
      <p style="color: #0ea5e9; font-size: 12px; margin-top: 12px;">Unidades en inventario</p>
    </div>

    <!-- Widget: Productos Agotados -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <p style="color: #888; font-size: 14px;">Productos Agotados</p>
          <h3 style="font-size: 32px; font-weight: bold; color: #dc2626; margin-top: 8px;">{productosAgotados}</h3>
        </div>
      </div>
      <p style="color: #dc2626; font-size: 12px; margin-top: 12px;">Requieren reabastecimiento</p>
    </div>

    <!-- Widget: Ingresos de Hoy -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <p style="color: #888; font-size: 14px;">Ingresos de Hoy</p>
          <h3 style="font-size: 32px; font-weight: bold; color: #10b981; margin-top: 8px;">{formatNumber(ingresosHoy)} €</h3>
        </div>
      </div>
      <p style="color: #10b981; font-size: 12px; margin-top: 12px;">Ventas realizadas hoy</p>
    </div>
  </div>

  <!-- Gráficas de Ventas -->
  <DashboardCharts client:load />

  <!-- Últimas Órdenes -->
  <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 32px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 style="font-size: 18px; font-weight: bold; color: #1a1a1a; margin: 0;">Últimas Órdenes</h3>
      <a href="/admin/ordenes" style="color: #4f46e5; text-decoration: none; font-size: 14px; font-weight: 500;">Ver todas &rarr;</a>
    </div>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid #e5e7eb;">
            <th style="text-align: left; padding: 12px; color: #666; font-weight: 600; font-size: 14px;">Nº Pedido</th>
            <th style="text-align: left; padding: 12px; color: #666; font-weight: 600; font-size: 14px;">Cliente</th>
            <th style="text-align: right; padding: 12px; color: #666; font-weight: 600; font-size: 14px;">Total</th>
            <th style="text-align: center; padding: 12px; color: #666; font-weight: 600; font-size: 14px;">Estado</th>
            <th style="text-align: right; padding: 12px; color: #666; font-weight: 600; font-size: 14px;">Fecha</th>
          </tr>
        </thead>
        <tbody>
          {ultimasOrdenes.length === 0 ? (
            <tr>
              <td colspan="5" style="text-align: center; padding: 24px; color: #999;">No hay órdenes recientes</td>
            </tr>
          ) : (
            ultimasOrdenes.map((orden: any) => {
               const estado = (orden.estado || 'pendiente').toLowerCase();
               let bg = '#e0f2fe'; let color = '#0369a1'; // Default Info/Blue

               if (estado === 'entregado' || estado === 'completada') { bg = '#dcfce7'; color = '#166534'; }
               else if (estado.includes('cancelad')) { bg = '#fee2e2'; color = '#991b1b'; }
               else if (estado === 'pendiente') { bg = '#fef3c7'; color = '#92400e'; }
               else if (estado === 'procesando' || estado === 'en proceso') { bg = '#fef3c7'; color = '#d97706'; } // Orange

               let readableEstado = estado === 'procesando' ? 'En proceso' : estado.charAt(0).toUpperCase() + estado.slice(1);
               if (estado === 'cancelada' || estado === 'cancelado') readableEstado = 'Cancelado';

               return (
              <tr style="border-bottom: 1px solid #e5e7eb; hover:background: #f9fafb;">
                <td style="padding: 12px; color: #1a1a1a; font-weight: 600;">#{orden.numero_orden || orden.id.toString().slice(0, 8)}</td>
                <td style="padding: 12px; color: #1a1a1a;">
                  <div style="font-weight: 500;">{orden.nombre || 'N/A'}</div>
                  <div style="font-size: 12px; color: #666;">{orden.email}</div>
                </td>
                <td style="padding: 12px; text-align: right; font-weight: 600; color: #1a1a1a;">{formatNumber(orden.total)} €</td>
                <td style="padding: 12px; text-align: center;">
                  <span style={`display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${bg}; color: ${color};`}>
                    {readableEstado}
                  </span>
                </td>
                <td style="padding: 12px; text-align: right; color: #666; font-size: 13px;">
                  {(() => {
                    const dateStr = orden.actualizado_en || orden.creado_en;
                    const safeDateStr = dateStr.endsWith('Z') || dateStr.includes('+') ? dateStr : dateStr + 'Z';
                    return new Date(safeDateStr).toLocaleString('es-ES', {
                      day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit',
                      timeZone: 'Europe/Madrid'
                    });
                  })()}
                </td>
              </tr>
            )})
          )}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Tabla de Productos con Bajo Stock -->
  {productosBalsoStock && productosBalsoStock.length > 0 && (
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <h3 style="font-size: 18px; font-weight: bold; color: #1a1a1a; margin: 0 0 16px 0;">Productos con Stock Bajo</h3>
      
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid #e5e7eb;">
              <th style="text-align: left; padding: 12px; color: #666; font-weight: 600; font-size: 14px;">Producto</th>
              <th style="text-align: center; padding: 12px; color: #666; font-weight: 600; font-size: 14px;">Stock</th>
              <th style="text-align: right; padding: 12px; color: #666; font-weight: 600; font-size: 14px;">Precio</th>
            </tr>
          </thead>
          <tbody>
            {productosBalsoStock.map((producto: any) => (
              <tr style="border-bottom: 1px solid #e5e7eb; hover:background: #f9fafb;">
                <td style="padding: 12px; color: #1a1a1a;">{producto.nombre}</td>
                <td style={`text-align: center; padding: 12px; font-weight: bold; ${
                  producto.stock === 0 
                    ? 'color: #dc2626;' 
                    : 'color: #f59e0b;'
                }`}>
                  {producto.stock} {producto.stock === 1 ? 'unidad' : 'unidades'}
                </td>
                <td style="text-align: right; padding: 12px; color: #1a1a1a;">{(producto.precio || 0).toFixed(2)} €</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )}
</AdminLayout>