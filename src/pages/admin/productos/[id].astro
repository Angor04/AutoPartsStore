---
// src/pages/admin/productos/nuevo.astro
// Formulario para crear nuevo producto

import AdminLayout from "@/layouts/AdminLayout.astro";
import Button from "@/components/ui/Button.astro";
import { getCategories } from "@/lib/supabase";

const categories = await getCategories();
const title = "Nuevo Producto";
const description = "Crea un nuevo producto en tu catálogo";
---

<AdminLayout title={title} description={description}>
  <div class="max-w-2xl">
    <form method="POST" action="/api/admin/productos/crear" enctype="multipart/form-data" class="space-y-8">
      <!-- Nombre -->
      <div>
        <label for="name" class="block text-sm font-semibold text-charcoal-900 mb-2">
          Nombre del Producto
        </label>
        <input
          type="text"
          id="name"
          name="name"
          placeholder="Ej: Camisa de Algodón Premium"
          class="w-full px-4 py-2 border border-charcoal-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
          required
        />
      </div>

      <!-- Descripción -->
      <div>
        <label for="description" class="block text-sm font-semibold text-charcoal-900 mb-2">
          Descripción
        </label>
        <textarea
          id="description"
          name="description"
          rows="4"
          placeholder="Describe el producto con detalles sobre material, acabado, etc."
          class="w-full px-4 py-2 border border-charcoal-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
          required
        ></textarea>
      </div>

      <!-- Categoría -->
      <div>
        <label for="category_id" class="block text-sm font-semibold text-charcoal-900 mb-2">
          Categoría
        </label>
        <select
          id="category_id"
          name="category_id"
          class="w-full px-4 py-2 border border-charcoal-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
          required
        >
          <option value="">Selecciona una categoría</option>
          {categories.map((cat) => (
            <option value={cat.id}>{cat.nombre}</option>
          ))}
        </select>
      </div>

      <!-- Precio y Stock -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="price" class="block text-sm font-semibold text-charcoal-900 mb-2">
            Precio (€)
          </label>
          <input
            type="number"
            id="price"
            name="price"
            step="0.01"
            min="0"
            placeholder="0.00"
            class="w-full px-4 py-2 border border-charcoal-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
            required
          />
        </div>

        <div>
          <label for="stock" class="block text-sm font-semibold text-charcoal-900 mb-2">
            Stock
          </label>
          <input
            type="number"
            id="stock"
            name="stock"
            min="0"
            placeholder="0"
            class="w-full px-4 py-2 border border-charcoal-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
            required
          />
        </div>
      </div>

      <!-- Imágenes -->
      <div>
        <label for="images" class="block text-sm font-semibold text-charcoal-900 mb-2">
          Imágenes del Producto
        </label>
        <div class="border-2 border-dashed border-charcoal-300 rounded-lg p-8 text-center hover:border-navy-500 transition-colors cursor-pointer">
          <input
            type="file"
            id="images"
            name="images"
            multiple
            accept="image/*"
            class="hidden"
          />
          <svg class="w-12 h-12 text-charcoal-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <p class="text-charcoal-700 font-medium">
            Arrastra imágenes aquí o haz clic para seleccionar
          </p>
          <p class="text-sm text-charcoal-600 mt-1">
            Soporta JPG, PNG. Máximo 5 imágenes.
          </p>
        </div>
      </div>

      <!-- Featured -->
      <div class="flex items-center">
        <input
          type="checkbox"
          id="is_featured"
          name="is_featured"
          class="w-4 h-4 rounded border-charcoal-300 accent-navy-500"
        />
        <label for="is_featured" class="ml-2 text-sm text-charcoal-700">
          Destacar este producto en la página principal
        </label>
      </div>

      <!-- Buttons -->
      <div class="flex gap-4">
        <Button type="submit" variant="primary" size="lg">
          Crear Producto
        </Button>
        <Button href="/admin/productos" variant="outline" size="lg">
          Cancelar
        </Button>
      </div>
    </form>
  </div>

  <script>
    const fileInput = document.getElementById('images');
    const dropZone = document.querySelector('[data-drop-zone]') || fileInput?.parentElement?.parentElement;

    if (dropZone) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e: Event): void {
        e.preventDefault();
        (e as DragEvent).stopPropagation();
      }

      dropZone.addEventListener('drop', handleDrop, false);

      function handleDrop(e: Event): void {
        const dt = (e as DragEvent).dataTransfer;
        const files = dt?.files;
        const fileInputElem = document.getElementById('imagenes') as HTMLInputElement | null;
        if (fileInputElem && files) {
          fileInputElem.files = files;
        }
      }
    }
  </script>
</AdminLayout>
