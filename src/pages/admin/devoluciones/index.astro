---
// src/pages/admin/devoluciones/index.astro
// Panel de administraciÃ³n de devoluciones

export const prerender = false;

import AdminLayout from "@/layouts/AdminLayout.astro";
import { getSupabaseAdmin } from "@/lib/supabase";
import { formatPrice } from "@/lib/utils";

const supabaseAdmin = getSupabaseAdmin();

// Obtener todas las solicitudes de devoluciÃ³n con datos de la orden
const { data: devolucionesData, error } = await supabaseAdmin
  .from('solicitudes_devolucion')
  .select(`
    *,
    ordenes:orden_id (
      id,
      numero_orden,
      total,
      email,
      nombre,
      session_stripe_id
    )
  `)
  .order('creado_en', { ascending: false });

if (error) {
  console.error('Error fetching devoluciones:', error);
}

const devoluciones = (devolucionesData as any[]) || [];

// EstadÃ­sticas
const total = devoluciones.length;
const solicitadas = devoluciones.filter(d => d.estado?.toUpperCase() === 'SOLICITADA').length;
const aprobadas = devoluciones.filter(d => d.estado?.toUpperCase() === 'APROBADA').length;
const recibidas = devoluciones.filter(d => d.estado?.toUpperCase() === 'PRODUCTO_RECIBIDO').length;
const reembolsadas = devoluciones.filter(d => d.estado?.toUpperCase() === 'REEMBOLSADA').length;
const rechazadas = devoluciones.filter(d => d.estado?.toUpperCase() === 'RECHAZADA').length;

const estadoLabel: Record<string, string> = {
  'SOLICITADA': 'Solicitada',
  'APROBADA': 'Aprobada',
  'RECHAZADA': 'Rechazada',
  'PRODUCTO_RECIBIDO': 'Producto Recibido',
  'REEMBOLSADA': 'Reembolsada',
};
---

<AdminLayout title="GestiÃ³n de Devoluciones" description="Administra solicitudes de devoluciÃ³n y reembolsos">
  <style>
    .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #667eea; }
    .stat-number { font-size: 32px; font-weight: bold; color: #1a1a1a; }
    .stat-label { color: #666; font-size: 14px; margin-top: 5px; }

    table { width: 100%; border-collapse: collapse; }
    thead { background: #f9fafb; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
    th { font-weight: 600; color: #1a1a1a; }
    tbody tr:hover { background: #f3f4f6; }

    .badge { display: inline-block; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .badge-solicitada { background: #fef3c7; color: #92400e; }
    .badge-aprobada { background: #dcfce7; color: #166534; }
    .badge-rechazada { background: #fee2e2; color: #991b1b; }
    .badge-recibido { background: #e0f2fe; color: #0369a1; }
    .badge-reembolsada { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }

    .btn-action {
      padding: 6px 14px; border: 1px solid #ddd; border-radius: 6px;
      font-size: 13px; cursor: pointer; background: white; transition: all 0.2s;
    }
    .btn-action:hover { background: #f3f4f6; }
    .btn-aprobar { border-color: #86efac; color: #166534; }
    .btn-aprobar:hover { background: #f0fdf4; }
    .btn-rechazar { border-color: #fca5a5; color: #991b1b; }
    .btn-rechazar:hover { background: #fef2f2; }
    .btn-recibido { border-color: #93c5fd; color: #1e40af; }
    .btn-recibido:hover { background: #eff6ff; }
    .btn-reembolsar { border-color: #86efac; color: #166534; font-weight: 600; }
    .btn-reembolsar:hover { background: #f0fdf4; }

    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 1000;
      align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: white; border-radius: 12px; padding: 30px;
      max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
    }

    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
    .detail-label { color: #666; font-size: 13px; }
    .detail-value { font-weight: 600; color: #1a1a1a; font-size: 13px; }

    .input-group { margin: 15px 0; }
    .input-group label { display: block; font-size: 13px; color: #374151; margin-bottom: 5px; font-weight: 500; }
    .input-group input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }

    .toast {
      position: fixed; top: 20px; right: 20px; z-index: 2000;
      padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-100px);
      transition: transform 0.3s ease; max-width: 400px;
    }
    .toast.show { transform: translateY(0); }
    .toast-success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
    .toast-error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

    .motivo-desc {
      font-size: 12px; color: #666; margin-top: 2px;
      display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;
      overflow: hidden; text-overflow: ellipsis;
      cursor: pointer; transition: all 0.2s;
    }
    .motivo-desc.expanded {
      -webkit-line-clamp: unset; display: block;
    }
    .motivo-toggle {
      font-size: 11px; color: #3b82f6; cursor: pointer; margin-top: 3px;
      border: none; background: none; padding: 0; text-decoration: underline;
    }
    .motivo-toggle:hover { color: #1d4ed8; }
  </style>

  <div style="margin-bottom: 32px;">
    <h2 style="font-size: 24px; font-weight: bold; color: #1a1a1a; margin: 0 0 24px 0;">Devoluciones</h2>

    <!-- EstadÃ­sticas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 32px;">
      <div class="stat-card">
        <div class="stat-number">{total}</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-card" style="border-left-color: #fbbf24;">
        <div class="stat-number">{solicitadas}</div>
        <div class="stat-label">Solicitadas</div>
      </div>
      <div class="stat-card" style="border-left-color: #34d399;">
        <div class="stat-number">{aprobadas}</div>
        <div class="stat-label">Aprobadas</div>
      </div>
      <div class="stat-card" style="border-left-color: #60a5fa;">
        <div class="stat-number">{recibidas}</div>
        <div class="stat-label">Recibidas</div>
      </div>
      <div class="stat-card" style="border-left-color: #4ade80;">
        <div class="stat-number">{reembolsadas}</div>
        <div class="stat-label">Reembolsadas</div>
      </div>
      <div class="stat-card" style="border-left-color: #f87171;">
        <div class="stat-number">{rechazadas}</div>
        <div class="stat-label">Rechazadas</div>
      </div>
    </div>

    <!-- Tabla -->
    <div style="background: white; border-radius: 8px; overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Etiqueta</th>
            <th>NÂº Pedido</th>
            <th>Cliente</th>
            <th>Motivo</th>
            <th>Total Pedido</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {devoluciones.length === 0 ? (
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                No hay solicitudes de devoluciÃ³n.
              </td>
            </tr>
          ) : (
            devoluciones.map((dev: any) => {
              const estado = (dev.estado || 'SOLICITADA').toUpperCase();
              const orden = dev.ordenes || {};

              let badgeClass = 'badge-solicitada';
              if (estado === 'APROBADA') badgeClass = 'badge-aprobada';
              else if (estado === 'RECHAZADA') badgeClass = 'badge-rechazada';
              else if (estado === 'PRODUCTO_RECIBIDO') badgeClass = 'badge-recibido';
              else if (estado === 'REEMBOLSADA') badgeClass = 'badge-reembolsada';



              return (
                <tr id={`dev-${dev.id}`} data-estado={estado} data-orden-total={orden.total || 0}>
                  <td style="font-family: monospace; font-size: 12px; font-weight: 600;">
                    {dev.numero_etiqueta_devolucion || 'N/A'}
                  </td>
                  <td style="font-weight: 600;">{orden.numero_orden || 'N/A'}</td>
                  <td>
                    <div>{orden.nombre || 'N/A'}</div>
                    <div style="font-size: 12px; color: #0369a1;">{orden.email || ''}</div>
                  </td>
                  <td style="max-width: 220px;">
                    <div style="font-weight: 500;">{dev.motivo || 'N/A'}</div>
                    {dev.descripcion && (
                      <div>
                        <div class="motivo-desc" data-motivo-id={dev.id}>
                          {dev.descripcion}
                        </div>
                        <button class="motivo-toggle" onclick={`window.toggleMotivo('${dev.id}')`}>Ver mÃ¡s</button>
                      </div>
                    )}
                  </td>
                  <td style="font-weight: 600;">{formatPrice(orden.total || 0)}</td>
                  <td>
                    <span class={`badge ${badgeClass}`}>
                      {estadoLabel[estado] || estado}
                    </span>
                  </td>
                  <td style="font-size: 13px; color: #999;">
                    {(() => {
                      const dateStr = dev.actualizado_en || dev.creado_en;
                      if (!dateStr) return 'N/A';
                      const safeDateStr = dateStr.endsWith('Z') || dateStr.includes('+') ? dateStr : dateStr + 'Z';
                      return new Date(safeDateStr).toLocaleString('es-ES', {
                        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit',
                        timeZone: 'Europe/Madrid'
                      });
                    })()}
                  </td>
                  <td>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                      {estado === 'SOLICITADA' && (
                        <>
                          <button class="btn-action btn-aprobar" onclick={`window.cambiarEstadoDev('${dev.id}', 'APROBADA')`}>
                            Aprobar
                          </button>
                          <button class="btn-action btn-rechazar" onclick={`window.cambiarEstadoDev('${dev.id}', 'RECHAZADA')`}>
                            Rechazar
                          </button>
                        </>
                      )}
                      {estado === 'APROBADA' && (
                        <button class="btn-action btn-recibido" onclick={`window.cambiarEstadoDev('${dev.id}', 'PRODUCTO_RECIBIDO')`}>
                          Marcar Recibido
                        </button>
                      )}
                      {estado === 'PRODUCTO_RECIBIDO' && (
                        <button class="btn-action btn-reembolsar" onclick={`window.abrirModalReembolso('${dev.id}', ${orden.total || 0})`}>
                          Reembolsar
                        </button>
                      )}
                      {(estado === 'RECHAZADA' || estado === 'REEMBOLSADA') && (
                        <span style="font-size: 12px; color: #999; font-style: italic;">Estado final</span>
                      )}
                    </div>
                  </td>
                </tr>
              );
            })
          )}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal ConfirmaciÃ³n GenÃ©rico -->
  <div id="modal-confirmacion" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <h3 id="modal-title" style="margin: 0 0 10px 0; font-size: 18px; color: #1a1a1a;">Confirmar AcciÃ³n</h3>
      <p id="modal-message" style="color: #666; font-size: 14px; margin-bottom: 15px;">Â¿EstÃ¡s seguro?</p>

      <div id="modal-rechazo-container" style="display: none; margin-bottom: 15px; text-align: left;">
        <label style="display: block; font-size: 13px; color: #374151; margin-bottom: 5px; font-weight: 500;">Motivo del rechazo *</label>
        <textarea id="modal-rechazo-motivo" rows="3" placeholder="Escribe el motivo del rechazo para el cliente..." style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical; font-family: inherit;"></textarea>
      </div>

      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn-action" onclick="window.cerrarModalConfirmacion()">Cancelar</button>
        <button id="btn-modal-confirmar" class="btn-action" style="background: #1a1a1a; color: white; border: none; padding: 8px 20px;">
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Reembolso -->
  <div id="modal-reembolso" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #1a1a1a;">ðŸ’° Procesar Reembolso</h3>
      <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
        Se ejecutarÃ¡ un reembolso real en Stripe. Esta acciÃ³n es <strong>irreversible</strong>.
      </p>

      <div class="input-group">
        <label>Monto a reembolsar (â‚¬)</label>
        <input type="number" id="monto-reembolso" step="0.01" min="0.01" placeholder="Monto total del pedido" />
        <p style="font-size: 12px; color: #666; margin-top: 4px;">
          Total del pedido: <strong id="total-pedido-label">â‚¬0.00</strong>. DÃ©jalo vacÃ­o para reembolso completo.
        </p>
      </div>

      <div class="input-group">
        <label>NÃºmero de seguimiento (opcional)</label>
        <input type="text" id="numero-seguimiento" placeholder="Ej: MRW-123456789" />
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
        <button class="btn-action" onclick="window.cerrarModalReembolso()">Cancelar</button>
        <button id="btn-confirmar-reembolso" class="btn-action btn-reembolsar" style="padding: 8px 20px;">
          Confirmar Reembolso
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    let devolucionIdReembolso = '';

    function showToast(message: string, type: 'success' | 'error') {
      const toast = document.getElementById('toast')!;
      toast.textContent = message;
      toast.className = `toast toast-${type} show`;
      setTimeout(() => { toast.classList.remove('show'); }, 4000);
    }

    window.toggleMotivo = function(devId: string) {
      const desc = document.querySelector(`[data-motivo-id="${devId}"]`) as HTMLElement;
      const btn = desc?.parentElement?.querySelector('.motivo-toggle') as HTMLElement;
      if (!desc || !btn) return;
      const isExpanded = desc.classList.toggle('expanded');
      btn.textContent = isExpanded ? 'Ver menos' : 'Ver m\u00e1s';
    };

    let confirmCallback: (() => void) | null = null;

    window.cerrarModalConfirmacion = function() {
      document.getElementById('modal-confirmacion')!.classList.remove('active');
      confirmCallback = null;
      // Reset rechazo textarea
      const container = document.getElementById('modal-rechazo-container')!;
      container.style.display = 'none';
      (document.getElementById('modal-rechazo-motivo') as HTMLTextAreaElement).value = '';
    };

    function abrirModalConfirmacion(titulo: string, mensaje: string, onConfirm: () => void) {
      document.getElementById('modal-title')!.textContent = titulo;
      document.getElementById('modal-message')!.textContent = mensaje;
      const btn = document.getElementById('btn-modal-confirmar')!;
      
      // Reset estilos botÃ³n
      btn.style.background = '#1a1a1a';
      
      confirmCallback = onConfirm;
      document.getElementById('modal-confirmacion')!.classList.add('active');
    }

    document.getElementById('btn-modal-confirmar')?.addEventListener('click', () => {
      // Validate rejection reason if container is visible
      const rechazoContainer = document.getElementById('modal-rechazo-container')!;
      if (rechazoContainer.style.display !== 'none') {
        const motivo = (document.getElementById('modal-rechazo-motivo') as HTMLTextAreaElement).value.trim();
        if (!motivo) {
          (document.getElementById('modal-rechazo-motivo') as HTMLTextAreaElement).style.borderColor = '#ef4444';
          return; // Don't close or confirm without a reason
        }
      }
      if (confirmCallback) confirmCallback();
      window.cerrarModalConfirmacion();
    });

    window.cambiarEstadoDev = function(devolucionId: string, nuevoEstado: string) {
      const config: Record<string, { t: string, m: string, c: string }> = {
        'APROBADA': { 
          t: 'Aprobar Devoluci\u00f3n', 
          m: 'Se notificar\u00e1 al cliente para que env\u00ede el producto. \u00bfContinuar?', 
          c: '#166534' 
        },
        'RECHAZADA': { 
          t: 'Rechazar Devoluci\u00f3n', 
          m: 'Escribe el motivo del rechazo. El cliente ser\u00e1 notificado.', 
          c: '#991b1b' 
        },
        'PRODUCTO_RECIBIDO': { 
          t: 'Marcar como Recibido', 
          m: 'Confirma que has recibido el paquete f\u00edsico.', 
          c: '#1e40af' 
        },
      };

      const c = config[nuevoEstado] || { t: 'Cambiar Estado', m: `\u00bfCambiar estado a ${nuevoEstado}?`, c: '#1a1a1a' };

      // Show/hide rejection textarea
      const rechazoContainer = document.getElementById('modal-rechazo-container')!;
      if (nuevoEstado === 'RECHAZADA') {
        rechazoContainer.style.display = 'block';
      } else {
        rechazoContainer.style.display = 'none';
      }

      abrirModalConfirmacion(c.t, c.m, async () => {
        const bodyData: any = {
          devolucion_id: devolucionId,
          nuevo_estado: nuevoEstado
        };

        // Include rejection reason if applicable
        if (nuevoEstado === 'RECHAZADA') {
          bodyData.motivo_rechazo = (document.getElementById('modal-rechazo-motivo') as HTMLTextAreaElement).value.trim();
        }

        try {
          const response = await fetch('/api/admin/devoluciones/actualizar-estado-devolucion', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyData)
          });

          const data = await response.json();

          if (response.ok && data.success) {
            showToast(`Estado cambiado a ${nuevoEstado}. Email enviado.`, 'success');
            setTimeout(() => location.reload(), 1500);
          } else {
            showToast(data.error || 'Error al cambiar estado', 'error');
          }
        } catch (err) {
          showToast('Error de conexi\u00f3n', 'error');
        }
      });
      
      // Update button color dynamically
      const btn = document.getElementById('btn-modal-confirmar')!;
      btn.style.background = c.c;
    };

    window.abrirModalReembolso = function(devolucionId: string, totalPedido: number) {
      devolucionIdReembolso = devolucionId;
      const modal = document.getElementById('modal-reembolso')!;
      const montoInput = document.getElementById('monto-reembolso') as HTMLInputElement;
      const totalLabel = document.getElementById('total-pedido-label')!;
      const seguimientoInput = document.getElementById('numero-seguimiento') as HTMLInputElement;

      montoInput.value = '';
      montoInput.max = String(totalPedido);
      montoInput.placeholder = `${totalPedido.toFixed(2)} (total)`;
      totalLabel.textContent = `â‚¬${totalPedido.toFixed(2)}`;
      seguimientoInput.value = '';
      modal.classList.add('active');
    };

    window.cerrarModalReembolso = function() {
      document.getElementById('modal-reembolso')!.classList.remove('active');
      devolucionIdReembolso = '';
    };

    // Confirmar reembolso
    document.getElementById('btn-confirmar-reembolso')?.addEventListener('click', async () => {
      if (!devolucionIdReembolso) return;

      const montoInput = document.getElementById('monto-reembolso') as HTMLInputElement;
      const seguimientoInput = document.getElementById('numero-seguimiento') as HTMLInputElement;
      const btn = document.getElementById('btn-confirmar-reembolso') as HTMLButtonElement;

      const monto = montoInput.value ? parseFloat(montoInput.value) : null;
      const seguimiento = seguimientoInput.value.trim() || null;

      if (monto !== null && (isNaN(monto) || monto <= 0)) {
        showToast('El monto debe ser mayor que 0', 'error');
        return;
      }

      abrirModalConfirmacion('Confirmar Reembolso', 'El reembolso en Stripe es irreversible. Â¿Continuar?', async () => {
        btn.disabled = true;
        btn.textContent = 'Procesando...';

        try {
          const response = await fetch('/api/admin/devoluciones/actualizar-estado-devolucion', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              devolucion_id: devolucionIdReembolso,
              nuevo_estado: 'REEMBOLSADA',
              monto_reembolso: monto,
              numero_seguimiento: seguimiento
            })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            window.cerrarModalReembolso();
            showToast(`Reembolso de â‚¬${data.monto_reembolso?.toFixed(2) || '?'} procesado exitosamente`, 'success');
            setTimeout(() => location.reload(), 2000);
          } else {
            showToast(data.error || 'Error al procesar reembolso', 'error');
            btn.disabled = false;
            btn.textContent = 'Confirmar Reembolso';
          }
        } catch (err) {
          showToast('Error de conexiÃ³n', 'error');
          btn.disabled = false;
          btn.textContent = 'Confirmar Reembolso';
        }
      });

      const confirmBtn = document.getElementById('btn-modal-confirmar')!;
      confirmBtn.style.background = '#991b1b';
    });

    // Cerrar modal al hacer clic fuera
    document.getElementById('modal-reembolso')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) window.cerrarModalReembolso();
    });
  </script>
</AdminLayout>
