---
import PublicLayout from "@/layouts/PublicLayout.astro";

const title = "Estado del Pedido";
const description = "Consulta el estado de tu pedido";

// Obtener par치metros de URL para pre-rellenar (칰til si viene desde confirmaci칩n)
const url = new URL(Astro.request.url);
const preOrden = url.searchParams.get('orden') || '';
const preEmail = url.searchParams.get('email') || '';
---

<PublicLayout title={title} description={description}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-10">
      <h1 class="text-3xl font-serif font-bold text-charcoal-900 mb-2">Estado del Pedido</h1>
      <p class="text-charcoal-600">Introduce los datos de tu compra para ver el estado actual</p>
    </div>

    <div class="max-w-md mx-auto bg-white rounded-lg shadow-sm p-8 border border-gray-100">
      <form id="trackingForm" class="space-y-6">
        <div>
          <label for="numero_orden" class="block text-sm font-medium text-charcoal-700 mb-1">
            N칰mero de Pedido
          </label>
          <input 
            type="text" 
            id="numero_orden" 
            name="numero_orden" 
            required
            value={preOrden}
            placeholder="Ej: ORD-000123"
            class="w-full px-4 py-2 border border-charcoal-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent uppercase"
          />
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-charcoal-700 mb-1">
            Email de Compra
          </label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            required
            value={preEmail}
            placeholder="tu@email.com"
            class="w-full px-4 py-2 border border-charcoal-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
          />
        </div>

        <button 
          type="submit" 
          id="btnBuscar"
          class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors flex justify-center items-center gap-2"
        >
          <span>Buscar Pedido</span>
        </button>

        <div id="errorMessage" class="hidden p-3 bg-red-50 text-red-700 rounded-lg text-sm text-center"></div>
      </form>
    </div>

    <!-- Resultados -->
    <div id="resultadoOrden" class="hidden mt-12 bg-white rounded-lg shadow-sm overflow-hidden animate-fade-in">
      <!-- Header del Estado -->
      <div id="estadoHeader" class="px-8 py-6 bg-gray-50 border-b border-gray-100 flex flex-wrap justify-between items-center gap-4">
        <div>
          <p class="text-sm text-gray-500 mb-1">Pedido</p>
          <h2 id="resOrdenNum" class="text-2xl font-bold text-charcoal-900 font-mono"></h2>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-500 mb-1">Estado</p>
          <span id="resBadge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-gray-200 text-gray-700"></span>
        </div>
      </div>

      <div class="p-8">
        <!-- Detalles de env칤o y fechas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8 pb-8 border-b border-gray-100">
          <div>
            <h3 class="text-sm font-bold text-charcoal-900 uppercase tracking-wide mb-3">Fecha de Compra</h3>
            <p id="resFecha" class="text-gray-600"></p>
          </div>
          <div>
            <h3 class="text-sm font-bold text-charcoal-900 uppercase tracking-wide mb-3">Direcci칩n de Env칤o</h3>
            <p id="resDireccion" class="text-gray-600"></p>
          </div>
          <div>
            <h3 class="text-sm font-bold text-charcoal-900 uppercase tracking-wide mb-3">Resumen</h3>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-600">Items:</span>
              <span id="resItemsCount" class="font-medium"></span>
            </div>
            <div class="flex justify-between text-lg font-bold text-charcoal-900">
              <span>Total:</span>
              <span id="resTotal"></span>
            </div>
          </div>
        </div>
        
        <!-- Lista de productos -->
        <div>
           <h3 class="text-lg font-serif font-bold text-charcoal-900 mb-4">Productos</h3>
           <div id="listaProductos" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </div>
</PublicLayout>

<script is:inline>
  const ESTADOS_CONFIG = {
    'PENDIENTE': { bg: 'bg-yellow-100', text: 'text-yellow-800', label: 'Pendiente de Pago' },
    'PAGADO': { bg: 'bg-blue-100', text: 'text-blue-800', label: 'Pagado' },
    'PROCESANDO': { bg: 'bg-indigo-100', text: 'text-indigo-800', label: 'En Preparaci칩n' },
    'ENVIADO': { bg: 'bg-purple-100', text: 'text-purple-800', label: 'Enviado' },
    'ENTREGADO': { bg: 'bg-green-100', text: 'text-green-800', label: 'Entregado' },
    'CANCELADO': { bg: 'bg-red-100', text: 'text-red-800', label: 'Cancelado' }
  };

  function formatDate(dateString) {
    if (!dateString) return '';
    return new Date(dateString).toLocaleDateString('es-ES', {
      year: 'numeric', month: 'long', day: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function formatPrice(price) {
    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(price);
  }

  const form = document.getElementById('trackingForm');
  const btn = document.getElementById('btnBuscar');
  const errorMsg = document.getElementById('errorMessage');
  const resultDiv = document.getElementById('resultadoOrden');

  // Si hay datos pre-rellenados, autolanzar b칰squeda
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('orden') && urlParams.get('email')) {
    // Peque침o delay para asegurar que el DOM carg칩
    setTimeout(() => {
        form.dispatchEvent(new Event('submit'));
    }, 500);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // UI Loading
    btn.disabled = true;
    btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Buscando...`;
    errorMsg.classList.add('hidden');
    resultDiv.classList.add('hidden');

    const numero_orden = document.getElementById('numero_orden').value.trim();
    const email = document.getElementById('email').value.trim();

    try {
      const response = await fetch('/api/pedidos/estado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ numero_orden, email })
      });

      const data = await response.json();

      if (!response.ok || data.error) {
        throw new Error(data.error || 'Error al buscar el pedido');
      }

      const orden = data.orden;

      // Renderizar datos
      document.getElementById('resOrdenNum').textContent = orden.numero_orden;
      document.getElementById('resFecha').textContent = formatDate(orden.fecha_creacion);
      document.getElementById('resTotal').textContent = formatPrice(orden.total);
      
      // Renderizar Badge de Estado
      const estadoKey = (orden.estado || '').toUpperCase();
      const config = ESTADOS_CONFIG[estadoKey] || { bg: 'bg-gray-100', text: 'text-gray-800', label: orden.estado };
      const badge = document.getElementById('resBadge');
      badge.className = `inline-flex items-center px-4 py-1.5 rounded-full text-sm font-bold ${config.bg} ${config.text}`;
      badge.textContent = config.label;

      // Renderizar Direcci칩n
      const dir = orden.direccion_envio || {};
      const dirTexto = [
        dir.calle,
        `${dir.ciudad || ''} ${dir.codigo_postal || ''}`,
        dir.provincia,
        dir.pais
      ].filter(Boolean).join(', ');
      document.getElementById('resDireccion').textContent = dirTexto || 'Direcci칩n no disponible';

      // Items
      const itemsContainer = document.getElementById('listaProductos');
      document.getElementById('resItemsCount').textContent = orden.ordenes_items?.length || 0;
      
      itemsContainer.innerHTML = (orden.ordenes_items || []).map(item => {
        const img = item.productos?.urls_imagenes?.[0] || null;
        return `
          <div class="flex items-center gap-4 py-3 border-b border-gray-50 last:border-0">
            <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border border-gray-100 flex-shrink-0">
              ${img ? `<img src="${img}" class="w-full h-full object-cover">` : '<span class="text-2xl text-gray-300">游닍</span>'}
            </div>
            <div class="flex-1">
              <p class="font-medium text-charcoal-900">${item.productos?.nombre || 'Producto'}</p>
              <p class="text-sm text-gray-500">
                ${item.cantidad} x ${formatPrice(item.precio_unitario)}
              </p>
            </div>
            <p class="font-bold text-charcoal-700">${formatPrice(item.subtotal)}</p>
          </div>
        `;
      }).join('');

      resultDiv.classList.remove('hidden');

    } catch (error) {
      errorMsg.textContent = error.message;
      errorMsg.classList.remove('hidden');
    } finally {
      btn.disabled = false;
      btn.innerHTML = `<span>Buscar Pedido</span>`;
    }
  });
</script>

<style>
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fade-in 0.5s ease-out forwards;
  }
</style>
